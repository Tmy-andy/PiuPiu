{% extends "base.html" %}
{% block title %}L·ªãch s·ª≠ game{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3 col-md-4">
        {% include "_sidebar.html" %}
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 col-md-8">
        <!-- Header Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                    <div>
                        <h1 class="card-title fw-bold mb-2">
                            <i class="fas fa-history me-2 text-theme-primary"></i>
                            L·ªãch s·ª≠ c√°c v√°n ch∆°i
                        </h1>
                        <p class="card-text text-theme-primary mb-0">Qu·∫£n l√Ω v√† theo d√µi c√°c v√°n game ƒë√£ di·ªÖn ra</p>
                    </div>
                    {% if session.user_role == 'admin' %}
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#newGameModal">
                        <i class="fas fa-plus me-2"></i>
                        <span class="d-none d-sm-inline">T·∫°o v√°n m·ªõi</span>
                        <span class="d-sm-none">T·∫°o m·ªõi</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title opacity-75">T·ªïng s·ªë v√°n</h6>
                                <h2 class="fw-bold mb-0">{{ games|length if games else 0 }}</h2>
                            </div>
                            <i class="fas fa-gamepad fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Games History Table -->
        <div class="card">
            <div class="card-header ">
                <h5 class="card-title fw-bold mb-0">
                    <i class="fas fa-list me-2 text-theme-primary"></i>
                    Danh s√°ch l·ªãch s·ª≠ v√°n
                </h5>
            </div>
            <div class="card-body">
                {% if games %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <i class="fas fa-clock me-1"></i>
                                    <span class="d-none d-md-inline">Th·ªùi gian</span>
                                    <span class="d-md-none">Ng√†y</span>
                                </th>
                                <th>
                                    <i class="fas fa-user-tie me-1"></i>
                                    <span class="d-none d-sm-inline">Qu·∫£n tr√≤</span>
                                    <span class="d-sm-none">QT</span>
                                </th>
                                <th>
                                    <i class="fas fa-users me-1"></i>
                                    <span class="d-none d-md-inline">Ng∆∞·ªùi ch∆°i & vai tr√≤</span>
                                    <span class="d-md-none">Ng∆∞·ªùi ch∆°i</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set FACTION_ICONS = {
                                "Phe D√¢n": ("fa-users", "bg-success text-white"),                 
                                "Phe S√≥i": ("fa-brands fa-wolf-pack-battalion", "bg-danger-subtle text-danger"), 
                                "Phe Ba": ("fa-user-secret", "bg-secondary-subtle text-dark"),                  
                                "ƒê·ªïi Phe": ("fa-random", "bg-warning-subtle text-warning")          
                            } %}

                            {% for game in games %}
                            <tr class="game-row" style="cursor: pointer;">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt text-theme-primary me-2"></i>
                                        <div>
                                            <span class="fw-semibold">{{ game.created_at.strftime('%d/%m/%Y') }}</span>
                                            <div class="small text-theme-primary d-none d-md-block">{{ game.created_at.strftime('%H:%M') }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-success text-white me-2">
                                            {{ game.host.member_id[-3:].upper() if game.host else "None" }}
                                        </div>
                                    </div>
                                </td>
                                {% set FACTION_ICONS = {
                                    "Phe D√¢n": ("fa-users", "bg-success text-white"),
                                    "Phe S√≥i": ("fa-skull-crossbones", "bg-danger-subtle text-danger"),
                                    "Phe Ba": ("fa-user-secret", "bg-secondary-subtle text-dark"),
                                    "ƒê·ªïi Phe": ("fa-random", "bg-warning-subtle text-warning")
                                } %}

                                <td>
                                    <div class="players-list">
                                        {% set factions_order = ['Phe D√¢n', 'Phe S√≥i', 'Phe Ba', 'ƒê·ªïi Phe'] %}
                                        {% for faction in factions_order %}
                                            {% for p in game.players if p.char.faction == faction %}
                                                {% set icon, color_class = FACTION_ICONS.get(p.char.faction, ('fa-question-circle', 'bg-secondary text-white')) %}
                                                <div class="player-item mb-1">
                                                    <span class="badge bg-secondary me-1">
                                                    {{ p.player.member_id[-3:] if p.player else "None" }}
                                                </span>
                                                    <span class="text-theme-primary"> : </span>
                                                    <span class="badge ms-1 {{ color_class }}">
                                                        <i class="fas {{ icon }} me-1"></i>{{ p.char.name }}
                                                    </span>
                                                </div>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>

                            <tr class="game-detail-row" style="display: none;">
                                <td colspan="3">
                                    <div class="p-3 bg-light border rounded">
                                        <!-- Tags -->
                                        <p class="mb-2">
                                            <strong>Tag:</strong>
                                            {% set tag_list = game.tags.split(',') if game.tags else [] %}
                                            {% if tag_list %}
                                                {% for tag in tag_list %}
                                                    <span class="badge bg-secondary me-1">{{ tag }}</span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-theme-primary">Ch∆∞a c√≥</span>
                                            {% endif %}
                                        </p>
                                        <!-- Ghi ch√∫ -->
                                        <p class="mb-2">
                                            <strong>Ghi ch√∫:</strong><br>
                                            {{ game.notes.replace('\n', '<br>') | safe if game.notes else 'Ch∆∞a c√≥ ghi ch√∫.' }}
                                        </p>

                                        {% if session.user_role == 'admin' %}
                                        <!-- Form ch·ªânh s·ª≠a -->
                                        <form method="POST" action="{{ url_for('update_game_note', game_id=game.id) }}" class="mt-3">
                                            <div class="mb-2">
                                                <label for="note{{ game.id }}" class="form-label fw-semibold">S·ª≠a ghi ch√∫:</label>
                                                <textarea class="form-control" name="note" id="note{{ game.id }}" rows="2">{{ game.notes or '' }}</textarea>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label fw-semibold">Ch·ªçn tag:</label><br>
                                                {% set all_tags = ['Th∆∞·ªùng', 'Gi√°o √°n', 'C·∫•m ch·ªçn'] %}
                                                {% for tag in all_tags %}
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" name="tags" id="tag_{{ game.id }}_{{ loop.index }}" value="{{ tag }}"
                                                        {% if tag in tag_list %}checked{% endif %}>
                                                    <label class="form-check-label" for="tag_{{ game.id }}_{{ loop.index }}">{{ tag }}</label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button type="submit" class="btn btn-sm btn-success me-2">
                                                <i class="fas fa-save me-1"></i> L∆∞u thay ƒë·ªïi
                                            </button>
                                            <a href="{{ url_for('delete_game', game_id=game.id) }}" class="btn btn-sm btn-danger"
                                            onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a v√°n n√†y kh√¥ng?');">
                                                <i class="fas fa-trash me-1"></i> X√≥a v√°n
                                            </a>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-gamepad fa-4x text-theme-primary mb-3"></i>
                    <h4 class="text-theme-primary">Ch∆∞a c√≥ v√°n n√†o</h4>
                    <p class="text-theme-primary mb-4">H√£y t·∫°o v√°n ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    {% if session.user_role == 'admin' %}
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#newGameModal">
                        <i class="fas fa-plus me-2"></i>T·∫°o v√°n m·ªõi
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal t·∫°o v√°n m·ªõi -->
<div class="modal fade" id="newGameModal" tabindex="-1" aria-labelledby="newGameModalLabel">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="newGameForm" method="POST" action="{{ url_for('create_game') }}">
        <input type="hidden" name="mode" id="gameModeInput" value="random">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus me-2"></i>T·∫°o v√°n m·ªõi
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>

        <div class="modal-body">
          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="gameModeTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="random-tab" data-bs-toggle="tab" data-bs-target="#random-mode" type="button" role="tab">Ph√¢n ng·∫´u nhi√™n</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-mode" type="button" role="tab">Ph√¢n th·ªß c√¥ng</button>
            </li>
          </ul>

          <div class="tab-content" id="gameModeContent">
            <!-- Tab: Ph√¢n ng·∫´u nhi√™n -->
            <div class="tab-pane fade show active" id="random-mode" role="tabpanel">
              <!-- Giao di·ªán ch·ªçn ng∆∞·ªùi ch∆°i & nh√¢n v·∫≠t random -->
              <div class="row g-4">
                <div class="col-12">
                  <div class="selection-container">
                    <label for="players" class="form-label fw-semibold">
                      <i class="fas fa-users me-2 text-theme-primary"></i>Ng∆∞·ªùi ch∆°i:
                    </label>
                    <div class="custom-select-wrapper">
                      <div class="custom-select" id="playersSelect">
                        <div class="select-header" data-target="players">
                          <span class="select-placeholder">Ch·ªçn ng∆∞·ªùi ch∆°i...</span>
                          <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="select-dropdown">
                          <div class="select-search">
                            <input type="text" placeholder="T√¨m ki·∫øm..." class="form-control form-control-sm">
                          </div>
                          <div class="select-options">
                            {% for u in users %}
                            <div class="select-option" data-value="{{ u.id }}" data-name="{{ u.member_id[-3:] }}">
                              <div class="option-content">
                                <div class="avatar-circle bg-primary text-white me-2">
                                  {{ u.member_id[-3:].upper() }}
                                </div>
                                <span>{{ u.member_id[-3:] }}</span>
                              </div>
                              <div class="option-checkbox">
                                <i class="fas fa-check"></i>
                              </div>
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                      <div class="selected-items" id="selectedPlayers"></div>
                      <select class="form-select d-none" name="players" id="players" multiple>
                        {% for u in users %}
                        <option value="{{ u.id }}" data-name="{{ u.member_id[-3:] }}">{{ u.member_id[-3:] }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="selection-container">
                    <label for="chars" class="form-label fw-semibold">
                      <i class="fas fa-mask me-2 text-theme-primary"></i>Nh√¢n v·∫≠t:
                    </label>
                    <div class="custom-select-wrapper">
                      <div class="custom-select" id="charsSelect">
                        <div class="select-header" data-target="chars">
                          <span class="select-placeholder">Ch·ªçn nh√¢n v·∫≠t...</span>
                          <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="select-dropdown">
                          <div class="select-search">
                            <input type="text" placeholder="T√¨m ki·∫øm..." class="form-control form-control-sm">
                          </div>
                          <div class="select-options">
                            {% for char in chars %}
                              {% set icon, color_class = FACTION_ICONS.get(char.faction, ('fa-question-circle', 'bg-secondary text-white')) %}
                              <div class="select-option" data-value="{{ char.id }}" data-name="{{ char.name }}">
                                <div class="option-content">
                                  <div class="character-icon me-2 {{ color_class }}" title="{{ char.faction }}">
                                    <i class="fas {{ icon }}"></i>
                                  </div>
                                  <span class="char-name">{{ char.name }}</span>
                                  <span class="char-count badge bg-secondary ms-2" style="display: none;">x1</span>
                                </div>
                                <div class="option-checkbox">
                                  <i class="fas fa-check"></i>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                      <div class="selected-items" id="selectedChars"></div>
                    </div>
                    <input type="hidden" name="char_ids" id="char_ids">
                    <select class="form-select d-none" name="char_ids[]" id="chars" multiple></select>
                  </div>
                </div>
              </div>

              <div class="text-center my-4">
                <button type="button" class="btn btn-secondary btn-lg" id="randomizeBtn">
                  <i class="fas fa-dice me-2"></i>Ph√¢n ng·∫´u nhi√™n
                </button>
              </div>

              <div id="assignmentsBox" class="mb-3" style="display: none;">
                <div class="card bg-light">
                  <div class="card-header">
                    <h6 class="card-title mb-0">
                      <i class="fas fa-check-circle text-success me-2"></i>
                      K·∫øt qu·∫£ ph√¢n vai
                    </h6>
                  </div>
                  <div class="card-body">
                    <ul id="assignmentsList" class="list-unstyled mb-0"></ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Ph√¢n th·ªß c√¥ng -->
            <div class="tab-pane fade" id="manual-mode" role="tabpanel">
              <div class="mb-3">
                <label class="form-label fw-semibold">Ch·ªçn v√† gh√©p ng∆∞·ªùi ch∆°i v·ªõi nh√¢n v·∫≠t:</label>
                <div id="manualAssignments">
                  <div class="row mb-2 align-items-center">
                    <div class="col-md-5">
                      <select class="form-select" name="manual_players[]" required>
                        {% for u in users %}
                          <option value="{{ u.id }}">{{ u.member_id[-3:] }} - {{ u.display_name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-5">
                      <select class="form-select" name="manual_chars[]" required>
                        {% for char in chars %}
                          <option value="{{ char.id }}">{{ char.name }} ({{ char.faction }})</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-danger btn-sm remove-row">X√≥a</button>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="addAssignmentRow">
                  <i class="fas fa-plus me-1"></i>Th√™m d√≤ng
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>H·ªßy
          </button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-2"></i>X√°c nh·∫≠n & l∆∞u
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<style>
.avatar-circle {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    background: var(--primary-color);
    color: white;
}

.players-list {
    max-height: 120px;
    overflow-y: auto;
}

.player-item {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

.selection-container {
    margin-bottom: 20px;
}

.custom-select-wrapper {
    position: relative;
}

.custom-select {
    position: relative;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 0.375rem;
    transition: all 0.3s ease;
    color: var(--text-primary);
}

.custom-select:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgba), 0.25);
}

.select-header {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--input-bg);
    border-radius: 0.375rem;
    min-height: 48px;
}

.select-header:hover {
    background: var(--bg-secondary);
}

.select-placeholder {
    color: var(--text-theme-primary);
    flex: 1;
}

.select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.select-dropdown.show {
    display: block;
}

.select-search {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}

.select-options {
    max-height: 200px;
    overflow-y: auto;
}

.select-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
    min-height: 48px;
    overflow-y: auto;
    color: var(--text-primary);
}

.select-option:hover {
    background: var(--bg-secondary);
}

.select-option.selected {
    background: rgba(var(--primary-color-rgba), 0.1);
    color: var(--primary-color);
}

.select-option.highlighted {
    background-color: rgba(var(--primary-color-rgba), 0.1);
    border-left: 4px solid var(--primary-color);
}

.option-content {
    display: flex;
    align-items: center;
    flex: 1;
}

.option-checkbox {
    color: var(--primary-color);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.select-option.selected .option-checkbox {
    opacity: 1;
}

.character-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(255, 193, 7, 0.1); /* v·∫´n gi·ªØ v√†ng ƒë·∫∑c tr∆∞ng */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.character-icon i,
.players-list .badge i {
    color: inherit !important;
}

.selected-items {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.selected-item {
    background: var(--primary-color);
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.remove-item {
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    transition: all 0.2s ease;
}

.remove-item:hover {
    background: rgba(255, 255, 255, 0.3);
}

#assignmentsList li {
    padding: 8px 12px;
    margin-bottom: 5px;
    background-color: var(--bg-secondary);
    border-radius: 5px;
    border-left: 4px solid var(--success-color);
}

/* Responsive */
@media (max-width: 768px) {
    .players-list {
        max-height: 100px;
    }

    .player-item {
        justify-content: center;
    }

    .modal-lg {
        margin: 10px;
    }

    .custom-select {
        touch-action: manipulation;
    }

    .select-option {
        padding: 1rem;
        font-size: 16px;
        min-height: 56px;
    }

    .select-header {
        min-height: 56px;
        padding: 1rem;
    }
}

</style>

{% endblock %}

{% block scripts %}

<script>
    const originalPlayers = {{ user_dicts | tojson | safe }};
    const originalChars = {{ char_dicts | tojson | safe }};
</script>

<script>
let randomizedCharIds = [];
document.addEventListener("DOMContentLoaded", function () {
    // ----- Custom Select Implementation -----
    class CustomSelect {
        constructor(container, realSelect) {
            this.container = container;
            this.realSelect = realSelect;
            this.header = container.querySelector('.select-header');
            this.dropdown = container.querySelector('.select-dropdown');
            this.searchInput = container.querySelector('.select-search input');
            this.options = container.querySelectorAll('.select-option');
            this.selectedContainer = container.parentElement.querySelector('.selected-items');
            this.selectedItems = [];
            this.init();
        }
        
        init() {
            this.header.addEventListener('click', () => this.toggleDropdown());
            this.searchInput.addEventListener('input', (e) => this.filterOptions(e.target.value));
            this.options.forEach(option => {
                option.addEventListener('click', () => this.selectOption(option));
            });
            document.addEventListener('click', (e) => {
                if (!this.container.contains(e.target)) {
                    this.closeDropdown();
                }
            });
        }
        
        toggleDropdown() {
            this.dropdown.classList.toggle('show');
            if (this.dropdown.classList.contains('show')) this.searchInput.focus();
        }
        
        closeDropdown() {
            this.dropdown.classList.remove('show');
        }
        
        filterOptions(searchTerm) {
            this.options.forEach(option => {
                const text = option.textContent.toLowerCase();
                const matches = text.includes(searchTerm.toLowerCase());
                option.style.display = matches ? 'flex' : 'none';
            });
        }
        
        selectOption(option) {
            const value = option.dataset.value;
            const name = option.dataset.name;
            if (this.container.id === 'playersSelect') {
                const exists = this.selectedItems.find(item => item.value === value);
                if (exists) return;
            }
            this.addOption(option, value, name);
            this.updatePlaceholder();
            this.updateRealSelect();
        }

        addOption(option, value, name) {
            this.selectedItems.push({value, name, option});
            const selectedItem = document.createElement('div');
            selectedItem.className = 'selected-item';
            selectedItem.dataset.value = value;
            selectedItem.innerHTML = `
                <span>${name}</span>
                <div class="remove-item" data-value="${value}">
                    <i class="fas fa-times"></i>
                </div>
            `;
            selectedItem.querySelector('.remove-item').addEventListener('click', () => {
                this.deselectOption(option, value);
            });
            this.selectedContainer.appendChild(selectedItem);
            if (this.container.id === 'charsSelect') this.updateCharCount(value);
        }

        deselectOption(option, value) {
            const index = this.selectedItems.findIndex(item => item.value === value);
            if (index !== -1) this.selectedItems.splice(index, 1);
            const selectedItem = this.selectedContainer.querySelector(`[data-value="${value}"]`);
            if (selectedItem) selectedItem.remove();
            if (this.container.id === 'charsSelect') this.updateCharCount(value);
            const realOption = this.realSelect.querySelector(`option[value="${value}"]`);
            if (realOption) realOption.selected = false;
            this.updatePlaceholder();
            this.updateRealSelect();    
        }
        
        updatePlaceholder() {
            const placeholder = this.header.querySelector('.select-placeholder');
            if (this.selectedItems.length === 0) {
                placeholder.textContent = this.container.id === 'playersSelect' ? 'Ch·ªçn ng∆∞·ªùi ch∆°i...' : 'Ch·ªçn nh√¢n v·∫≠t...';
                placeholder.style.color = '#6c757d';
            } else {
                placeholder.textContent = `ƒê√£ ch·ªçn ${this.selectedItems.length} m·ª•c`;
                placeholder.style.color = '#212529';
            }
        }
        
        updateRealSelect() {
            const options = this.realSelect.options;

            // Reset to√†n b·ªô selected
            for (let i = 0; i < options.length; i++) {
                options[i].selected = false;
            }

            // Set selected cho c√°c item ƒë√£ ch·ªçn
            this.selectedItems.forEach(item => {
                for (let i = 0; i < options.length; i++) {
                    if (String(options[i].value) === String(item.value)) {
                        options[i].selected = true;
                        break;
                    }
                }
            });

            // N·∫øu l√† char th√¨ c·∫≠p nh·∫≠t hidden input
            if (this.realSelect.name === "players") return;

            if (this.realSelect.name === "char_ids") {
                const hiddenInput = document.getElementById("char_ids");
                const allCharIds = this.selectedItems.map(item => item.value);
                hiddenInput.value = allCharIds.join(',');
            }
        }

        updateCharCount(value) {
            const count = this.selectedItems.filter(item => item.value === value).length;
            const optionElems = Array.from(this.options).filter(opt => opt.dataset.value === value);
            optionElems.forEach(opt => {
                const badge = opt.querySelector('.char-count');
                if (count > 0) {
                    badge.style.display = "inline-block";
                    badge.textContent = `x${count}`;
                    opt.classList.add("highlighted");
                } else {
                    badge.style.display = "none";
                    badge.textContent = "";
                    opt.classList.remove("highlighted");
                }
            });
        }
    }
    // üîÅ Ghi nh·∫≠n ch·∫ø ƒë·ªô ch∆°i v√†o input ·∫©n
    const gameModeInput = document.getElementById('gameModeInput');
    document.getElementById('random-tab').addEventListener('click', () => {
        gameModeInput.value = 'random';
    });
    document.getElementById('manual-tab').addEventListener('click', () => {
        gameModeInput.value = 'manual';
    });

    // Init Custom Selects
    const playersSelect = new CustomSelect(
        document.getElementById('playersSelect'),
        document.getElementById('players')
    );
    const charsSelect = new CustomSelect(
        document.getElementById('charsSelect'),
        document.getElementById('chars')
    );

    // ----- Randomize Roles -----
    const randomizeBtn = document.getElementById("randomizeBtn");
    const listBox = document.getElementById("assignmentsList");
    const box = document.getElementById("assignmentsBox");

    randomizeBtn.addEventListener("click", function () {
        listBox.innerHTML = "";
        box.style.display = "none";

        const players = playersSelect.selectedItems;
        const chars = charsSelect.selectedItems.map(item => ({
            value: item.value,
            name: item.name
        }));

        if (players.length !== chars.length || players.length === 0) {
            alert("S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i v√† nh√¢n v·∫≠t ph·∫£i b·∫±ng nhau v√† l·ªõn h∆°n 0.");
            return;
        }

        const shuffledChars = chars.slice();
        for (let i = shuffledChars.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledChars[i], shuffledChars[j]] = [shuffledChars[j], shuffledChars[i]];
        }

        players.forEach((player, index) => {
            const li = document.createElement("li");
            li.innerHTML = `<i class="fas fa-user-check text-success me-2"></i><strong>${player.name}</strong> l√†m <strong class="text-theme-primary">${shuffledChars[index].name}</strong>`;
            listBox.appendChild(li);
        });

        box.style.display = "block";
        randomizedCharIds = shuffledChars.map(opt => opt.value);
    });

    // ----- Form Submit Handler -----
    document.getElementById("newGameForm").addEventListener("submit", function (e) {
        const activeTab = document.querySelector(".nav-tabs .nav-link.active");
        if (!activeTab || activeTab.id !== "random-tab") return;

        // ‚ùóÔ∏è B·∫ÆT BU·ªòC G·ªåI UPDATE TH·∫¨T
        playersSelect.updateRealSelect();
        charsSelect.updateRealSelect();

        const selectedPlayers = Array.from(document.getElementById("players").selectedOptions);
        const selectedChars = randomizedCharIds;

        if (selectedPlayers.length === 0 || selectedPlayers.length !== selectedChars.length) {
            alert("S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i v√† nh√¢n v·∫≠t ph·∫£i b·∫±ng nhau v√† l·ªõn h∆°n 0.");
            e.preventDefault();
            return;
        }

        document.getElementById("char_ids").value = selectedChars.join(",");
    });

    // ----- Th√™m/X√≥a d√≤ng ph√¢n th·ªß c√¥ng -----
    const container = document.getElementById("manualAssignments");
    document.getElementById("addAssignmentRow").addEventListener("click", function () {
        const newRow = document.createElement("div");
        newRow.className = "row mb-2 align-items-center";

        const playerOptions = originalPlayers.map(u =>
            `<option value="${u.id}">${u.member_id.slice(-3)} - ${u.display_name}</option>`).join('');

        const charOptions = originalChars.map(c =>
            `<option value="${c.id}">${c.name} (${c.faction})</option>`).join('');

        newRow.innerHTML = `
            <div class="col-md-5">
                <select class="form-select" name="manual_players[]" required>
                    <option disabled selected value="">-- Ch·ªçn ng∆∞·ªùi ch∆°i --</option>
                    ${playerOptions}
                </select>
            </div>
            <div class="col-md-5">
                <select class="form-select" name="manual_chars[]" required>
                    <option disabled selected value="">-- Ch·ªçn nh√¢n v·∫≠t --</option>
                    ${charOptions}
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm remove-row">X√≥a</button>
            </div>
        `;
        container.appendChild(newRow);
    });

    container.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-row")) {
            const row = e.target.closest(".row");
            const allRows = container.querySelectorAll(".row");
            if (allRows.length > 1) row.remove();
        }
    });

    // ----- Hi·ªán/·∫®n chi ti·∫øt v√°n ch∆°i -----
    const rows = document.querySelectorAll('.game-row');
    const detailRows = document.querySelectorAll('.game-detail-row');

    rows.forEach((row, index) => {
        row.addEventListener('click', () => {
            detailRows.forEach((r, i) => {
                r.style.display = (i === index && r.style.display !== 'table-row') ? 'table-row' : 'none';
            });
        });
    });
});
</script>

{% endblock %}
